{"version":3,"file":"/Users/ben/mydata/gitHubDir/ben-open-digger/hypertrons/app/lua-vm/lua-vm.ts","sources":["/Users/ben/mydata/gitHubDir/ben-open-digger/hypertrons/app/lua-vm/lua-vm.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2019 - present Xlab\n//\n// Licensed under the Apache License, Version 2.0 (the \"License\");\n// you may not use this file except in compliance with the License.\n// You may obtain a copy of the License at\n//\n//     http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS,\n// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n// See the License for the specific language governing permissions and\n// limitations under the License.\n\nimport fengari from 'fengari';\nimport { luaopen_base } from 'fengari/src/lbaselib';\nimport { luaopen_math } from 'fengari/src/lmathlib';\nimport { luaopen_string } from 'fengari/src/lstrlib';\nimport { luaopen_table } from 'fengari/src/ltablib';\nimport { luaopen_coroutine } from 'fengari/src/lcorolib';\nimport { readFileSync } from 'fs';\nimport { join } from 'path';\n\nconst lua = fengari.lua;\nconst lauxlib = fengari.lauxlib;\n\nconst luaBuidinCode = readFileSync(join(__dirname, 'helpers.lua')).toString();\n\nexport class LuaVm {\n\n  private L: any;\n  private ctx: Map<string, any>;\n\n  constructor() {\n    this.L = lauxlib.luaL_newstate();\n    // only load basic apis to vm\n    const map = new Map<string, any>();\n    map.set('_G', luaopen_base)\n      .set('string', luaopen_string)\n      .set('table', luaopen_table)\n      .set('math', luaopen_math)\n      .set('coroutine', luaopen_coroutine);\n    map.forEach((lib, name) => {\n      lauxlib.luaL_requiref(this.L, fengari.to_luastring(name), lib, 1);\n      lua.lua_pop(this.L, 1);\n    });\n    this.ctx = new Map<string, any>();\n  }\n\n  public run(source: string): any {\n    source = luaBuidinCode + source;\n    for (const [ key, value ] of this.ctx) {\n      const n = this.pushStackValue(this.L, value);\n      if (n !== 0) {\n        lua.lua_setglobal(this.L, key);\n      }\n    }\n    lauxlib.luaL_dostring(this.L, fengari.to_luastring(source));\n    return this.getStackValue(this.L, -1);\n  }\n\n  public set(key: string, value: any, target?: any): this {\n    if (typeof value === 'function') {\n      value = this.wrapFunc(key, value, target);\n    }\n    this.ctx.set(key, value);\n    return this;\n  }\n\n  private wrapFunc(key: string, func: (...args: any[]) => any, target?: any): any {\n    const wrapped = (L: any): any => {\n      // call in ts\n      const getArgs = (): any[] => {\n        const nArgs = lua.lua_gettop(L);\n        const args: any[] = [];\n        for (let i = 0 ; i < nArgs; i++) {\n          const value = this.getStackValue(L, i + 1);\n          args.push(value);\n        }\n        return args;\n      };\n      const args = getArgs();\n      // use call function to inject this object\n      const res = func.call(target, ...args);\n      if (res instanceof Promise && lua.lua_isyieldable(L)) {\n        // if a coroutine happened, yield and resume when promise return\n        Promise.resolve(res).then(r => {\n          if (r === undefined) {\n            // no return value\n            lua.lua_resume(L, this.L, 0);\n          } else {\n            this.pushStackValue(L, r);\n            lua.lua_resume(L, this.L, 1);\n          }\n        });\n        return lua.lua_yield(L, 0);\n      } else {\n        // set return value\n        return this.pushStackValue(L, res);\n      }\n    };\n    // save key as function name for debugging use\n    Object.defineProperty(func, 'name', { value: key });\n    return wrapped;\n  }\n\n  private getStackValue(L: any, index: number): any {\n    if (lua.lua_gettop(L) === 0) {\n      // no value, return undefined first\n      // otherwise, absindex will fail\n      return undefined;\n    }\n    index = lua.lua_absindex(L, index); // change to abs index in case iterate call error\n    const type = lua.lua_type(L, index);\n    switch (type) {\n      case lua.LUA_TNUMBER:\n        return lua.lua_tonumber(L, index);\n      case lua.LUA_TSTRING:\n        return lua.lua_tojsstring(L, index);\n      case lua.LUA_TBOOLEAN:\n        return lua.lua_toboolean(L, index);\n      case lua.LUA_TUSERDATA:\n        return lua.lua_touserdata(L, index);\n      case lua.LUA_TFUNCTION:\n        // lua_pushvalue will load index value on stack top\n        // luaL_ref will pop the value and store as a ref for later use\n        lua.lua_pushvalue(L, index);\n        const cbRef = lauxlib.luaL_ref(L, lua.LUA_REGISTRYINDEX);\n        return (...args: any[]): any => {\n          // get callback funtion and push to stack top\n          const oldStackTop = lua.lua_gettop(L);\n          lua.lua_rawgeti(L, lua.LUA_REGISTRYINDEX, cbRef);\n          args.forEach(p => {\n            // push all args in sequence\n            this.pushStackValue(L, p);\n          });\n          // call current function\n          let ret = lua.lua_pcall(L, args.length, lua.LUA_MULTRET, 0);\n          if (ret !== lua.LUA_OK) {\n            // If ret !=== lua.LUA_OK, means there are errors while executing the function\n            console.log(`Error when exec function, ret=${ret}, msg=${this.getStackValue(L, -1)}`);\n          }\n          ret = undefined;\n          if (lua.lua_gettop(L) !== oldStackTop) {\n            // after function call, stack top not equal means have return value\n            // get the last return value from stack\n            ret = this.getStackValue(L, -1);\n          }\n          return ret;\n        };\n      case lua.LUA_TTABLE:\n        // only support array and object\n        let v: any;\n        try {\n          lua.lua_rawgeti(L, index, 1);\n          v = this.getStackValue(L, -1);\n          lua.lua_pop(L, 1);\n        // tslint:disable-next-line: no-empty\n        } catch { }\n        if (v !== null && v !== undefined) {  // need to check like this\n          // array\n          const arr: any[] = [];\n          for (let i = 1; ; i++) {\n            lua.lua_rawgeti(L, index, i);\n            const v = this.getStackValue(L, -1);\n            lua.lua_pop(L, 1);\n            if (!v) break;\n            arr.push(v);\n          }\n          return arr;\n        } else {\n          const ret: any = {};\n          lua.lua_pushnil(L);\n          while (lua.lua_next(L, index) !== 0) {\n            // iterate keys and values from table at index\n            // lua_next will push key and value on stack\n            const value = this.getStackValue(L, -1);\n            const key = this.getStackValue(L, -2);\n            if (value && key) {\n              ret[key] = value;\n            }\n            lua.lua_pop(L, 1);\n          }\n          return ret;\n        }\n      case lua.LUA_TTHREAD:\n        return lua.lua_tothread(L, index);\n      case lua.LUA_TNONE:\n        return undefined;\n      case lua.LUA_TNIL:\n        return null;\n      default:\n        console.log(`Not supported type=${type}, index=${index}`);\n        return undefined;\n    }\n  }\n\n  private pushStackValue(L: any, value: any, target?: any): number {\n    const type = typeof value;\n    switch (type) {\n      case 'number':\n        lua.lua_pushnumber(L, value);\n        break;\n      case 'string':\n        lua.lua_pushstring(L, value);\n        break;\n      case 'boolean':\n        lua.lua_pushboolean(L, value);\n        break;\n      case 'object':\n        if (value === null || value === undefined) {\n          return 0;\n        } else if (Array.isArray(value)) {\n          // if pass in an array, push as a table, set index and value\n          lua.lua_newtable(L);\n          (value as any[]).forEach((v, i) => {\n            const n = this.pushStackValue(L, v);\n            if (n !== 0) {\n              lua.lua_rawseti(L, -2, i + 1);\n            } else {\n              lua.lua_pop(L, 1);\n            }\n          });\n        } else if (value instanceof Date) {\n          lua.lua_pushstring(L, value.toDateString());\n          break;\n        } else {\n          lua.lua_newtable(L);\n          Object.keys(value).forEach(key => {\n            lua.lua_pushstring(L, key);\n            const v = value[key];\n            let n = 0;\n            if (typeof v === 'function') {\n              // if the value is function, wrap and bind target and push back\n              const f = this.wrapFunc(v.name, v, target);\n              n = this.pushStackValue(L, f, value);\n            } else {\n              n = this.pushStackValue(L, value[key]);\n            }\n            if (n === 0) {\n              // not support type or not push into stack\n              // pop out the key\n              lua.lua_pop(L, 1);\n            } else {\n              // set table value into table\n              lua.lua_settable(L, -3);\n            }\n          });\n        }\n        break;\n      case 'function':\n        lua.lua_pushjsfunction(L, value);\n        break;\n      case 'undefined':\n        return 0;\n      default:\n        console.log(`Not supported type: ${type}`);\n        return 0;\n    }\n    return 1;\n  }\n\n  public getLuaBuidinCodeLines(): number {\n    return luaBuidinCode.split('\\n').length;\n  }\n\n}\n"]}